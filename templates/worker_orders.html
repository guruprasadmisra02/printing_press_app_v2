{% extends 'base.html' %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <h4>All Orders (Worker)</h4>
  <form method="get" class="d-flex align-items-center gap-2">
    <label class="form-label m-0">Month</label>
    <input type="month" name="month" value="{{ month }}" class="form-control">
    <button class="btn btn-outline-primary ms-2">Go</button>
  </form>
</div>

<hr>

<div class="table-responsive">
  <table class="table table-striped table-hover align-middle">
    <thead class="table-dark">
      <tr>
        <th>ID</th>
        <th>Customer</th>
        <th>Phone</th>
        <th>Product</th>
        <th>Qty</th>
        <th>Date</th>
        <th>Total (₹)</th>
        <th>Paid (₹)</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for o in orders %}
      <tr>
        <td>{{ o.id }}</td>

        <!-- Customer name & phone -->
        <td>{{ o.customer_display or 'N/A' }}</td>
        <td>{{ o.customer_phone or '-' }}</td>

        <!-- Basic order info -->
        <td>{{ o.product_name }}</td>
        <td>{{ o.quantity }}</td>
        <td>{{ o.date }}</td>

        <!-- Total cost with inline edit -->
        <td>
          {% if o.total_cost %}
            <span class="badge bg-success">₹{{ '%.2f'|format(o.total_cost) }}</span>
          {% else %}
            <span class="text-muted">Not set</span>
          {% endif %}
         
        <!-- Amount paid with add more -->
        <td>
          {% if o.amount_paid %}
            <span class="badge bg-info">₹{{ '%.2f'|format(o.amount_paid) }}</span>
          {% else %}
            <span class="text-muted">0.00</span>
          {% endif %}
          <button class="btn btn-sm btn-outline-success ms-2" data-bs-toggle="collapse" data-bs-target="#addPaid{{ o.id }}">
            Add
          </button>
          <div class="collapse mt-2" id="addPaid{{ o.id }}">
            <form method="post" class="d-flex gap-2">
              <input type="hidden" name="order_id" value="{{ o.id }}">
              <input type="hidden" name="action" value="update_paid">
              <input type="number" step="0.01" name="amount_paid"
                     class="form-control form-control-sm"
                     placeholder="Add amount">
              <button class="btn btn-sm btn-outline-success">Save</button>
            </form>
          </div>
        </td>

        <!-- Status update -->
        <td>
          <form method="post" class="d-flex gap-2 align-items-center">
            <input type="hidden" name="order_id" value="{{ o.id }}">
            <input type="hidden" name="action" value="update_status">
            <select name="status" class="form-select form-select-sm w-auto">
              {% for s in ['Pending','In Progress','Completed'] %}
                <option value="{{ s }}" {% if o.status == s %}selected{% endif %}>{{ s }}</option>
              {% endfor %}
            </select>
            <button class="btn btn-sm btn-outline-primary">Save</button>
          </form>
        </td>

        <!-- Actions: Bill + Items Used -->
        <td>
          <div class="d-flex flex-wrap gap-1">
            <!-- Full bill same as owner -->
            <a href="{{ url_for('download_bill_pdf', order_ids=o.id) }}"
               class="btn btn-sm btn-outline-info">
              Bill
            </a>

            <!-- Items Used toggle -->
            <button class="btn btn-sm btn-outline-dark"
                    data-bs-toggle="collapse"
                    data-bs-target="#items{{ o.id }}">
              Items Used
            </button>
          </div>
        </td>
      </tr>

      <!-- Items Used collapsible row -->
      <tr class="collapse" id="items{{ o.id }}">
        <td colspan="10">
          <div class="p-3 bg-light rounded border">
            <h6 class="mb-2">Items Used for Order #{{ o.id }}</h6>

            {% set used_items = [] %}
            {% if used is defined %}
              {% set used_items = used.get(o.id, []) %}
            {% endif %}

            {% if used_items %}
              <ul class="list-group mb-3">
                {% for item in used_items %}
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>
                      {{ item.item_name }}
                      {% if item.size %}
                        ({{ item.size }})
                      {% endif %}
                    </span>
                    <span class="badge bg-primary">
                      {{ item.quantity_used }}
                    </span>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-muted small mb-3">No items used yet.</p>
            {% endif %}

            <!-- Add new used item -->
            <form method="post"
                  action="{{ url_for('add_order_item', order_id=o.id) }}"
                  class="row g-2">
              <div class="col-md-5">
                <select name="stock_id" class="form-select form-select-sm" required>
                  <option value="" disabled selected>Select stock item...</option>
                  {% for s in stock %}
                    <option value="{{ s.id }}">
                      {{ s.item_name }}
                      {% if s.size %} ({{ s.size }}){% endif %}
                      — {{ s.quantity }} in stock
                    </option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-3">
                <input type="number" step="0.01" min="0.01"
                       name="qty_used"
                       class="form-control form-control-sm"
                       placeholder="Qty used"
                       required>
              </div>
              <div class="col-md-2">
                <button class="btn btn-sm btn-outline-secondary w-100">
                  Add
                </button>
              </div>
            </form>
          </div>
        </td>
      </tr>

      {% endfor %}
    </tbody>
  </table>
</div>

{% endblock %}
