{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center">
  <h4>All Orders (Owner)</h4>
  <form method="get" class="d-flex align-items-center gap-2">
    <label class="form-label m-0">Month</label>
    <input type="month" name="month" value="{{ month }}" class="form-control">
    <button class="btn btn-outline-primary">Go</button>
  </form>
</div>

<!-- ✅ Combined Bill Button -->
<form id="billForm" method="get" action="" target="_blank">
  <div class="d-flex justify-content-end mt-3">
    <button type="button" class="btn btn-success" onclick="generateCombinedBill()">Generate Combined Bill</button>
  </div>

  <div class="table-responsive mt-3">
    <table class="table table-striped table-hover align-middle">
      <thead class="table-dark">
        <tr>
          <th><input type="checkbox" id="selectAll"></th>
          <th>ID</th>
          <th>Customer</th>
          <th>Product</th>
          <th>Qty</th>
          <th>Date</th>
          <th>Total</th>
          <th>Paid</th>
          <th>Status</th>
          <th>Receive</th>
          <th>Items Used</th>
          <th>Update Paid</th>
          <th>Edit</th>
          <th>Delete</th>
          <th>Bill</th>
        </tr>
      </thead>
      <tbody>
        {% for o in orders %}
        <tr>
          <td><input type="checkbox" class="orderCheck" value="{{ o.id }}"></td>
          <td>{{ o.id }}</td>
          <td>{{ o.customer_name or o.phone or 'N/A' }}</td>
          <td>{{ o.product_name }}</td>
          <td>{{ '%.0f'|format(o.quantity) }}</td>
          <td>{{ o.date }}</td>

          <td>
            <form method="post" class="d-flex gap-2">
              <input type="hidden" name="order_id" value="{{ o.id }}">
              <input type="hidden" name="action" value="update_total_cost">
              <input type="number" step="0.01" name="total_cost" value="{{ o.total_cost or '' }}" class="form-control form-control-sm">
              <button class="btn btn-sm btn-outline-primary">Save</button>
            </form>
          </td>

          <td>{{ o.amount_paid or 0 }}</td>

          <td>
            <form method="post" class="d-flex gap-2">
              <input type="hidden" name="order_id" value="{{ o.id }}">
              <input type="hidden" name="action" value="update_status">
              <select name="status" class="form-select form-select-sm">
                {% for s in ['Pending','In Progress','Completed'] %}
                <option value="{{ s }}" {% if o.status==s %}selected{% endif %}>{{ s }}</option>
                {% endfor %}
              </select>
              <button class="btn btn-sm btn-primary">Save</button>
            </form>
          </td>

          <td>{{ o.receive_date or '-' }}</td>

          <!-- Items Used -->
          <td>
            <form method="post" action="{{ url_for('add_order_item', order_id=o.id) }}" class="d-flex gap-2">
              <select name="stock_id" class="form-select form-select-sm" required style="min-width:200px">
                <option value="" disabled selected>Select stock...</option>
                {% for s in stock %}
                <option value="{{ s.id }}">
                  {{ s.item_name }}{% if s.item_no %} ({{ s.item_no }}){% endif %}{% if s.size %} - {{ s.size }}{% endif %} | In Stock: {{ s.quantity }}
                </option>
                {% endfor %}
              </select>
              <input type="number" step="0.01" min="0.01" name="qty_used" class="form-control form-control-sm" placeholder="Qty" required>
              <button class="btn btn-sm btn-outline-secondary">Add</button>
            </form>
            <a class="small text-decoration-none" href="{{ url_for('worker_order_items', oid=o.id) }}">More…</a>
          </td>

          <td>
            <form method="post" class="d-flex gap-2">
              <input type="hidden" name="order_id" value="{{ o.id }}">
              <input type="hidden" name="action" value="update_paid">
              <input type="number" step="0.01" name="amount_paid" class="form-control form-control-sm" placeholder="0">
              <button class="btn btn-sm btn-success">Add</button>
            </form>
          </td>

          <td>
            <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('owner_edit_order', order_id=o.id) }}">Edit</a>
          </td>

          <td>
            <form method="post" onsubmit="return confirm('Delete this order?')">
              <input type="hidden" name="order_id" value="{{ o.id }}">
              <input type="hidden" name="action" value="delete_order">
              <button class="btn btn-sm btn-outline-danger">Delete</button>
            </form>
          </td>

          <td>
            <a href="{{ url_for('download_bill_pdf', order_ids=o.id) }}" class="btn btn-sm btn-outline-info">Bill</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</form>

<!-- ✅ JS for Select All & Combined Bill -->
<script>
document.getElementById("selectAll").addEventListener("change", function() {
  document.querySelectorAll(".orderCheck").forEach(cb => cb.checked = this.checked);
});

function generateCombinedBill() {
  let selected = [];
  document.querySelectorAll(".orderCheck:checked").forEach(cb => selected.push(cb.value));
  if (selected.length === 0) {
    alert("Please select at least one order to generate a bill.");
    return;
  }
  let ids = selected.join(",");
  window.open(`/download_bill_pdf/${ids}`, "_blank");
}
</script>
{% endblock %}

{% endblock %}



