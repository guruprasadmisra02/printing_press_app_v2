{% extends 'base.html' %}
{% block content %}

<div class="d-flex justify-content-between align-items-center">
  <h4>All Orders (Owner)</h4>
  <form method="get" class="d-flex align-items-center gap-2">
    <label class="form-label m-0">Month</label>
    <input type="month" name="month" value="{{ month }}" class="form-control">
    <button class="btn btn-outline-primary">Go</button>
  </form>
</div>

<hr>

<div class="table-responsive">
  <table class="table table-striped table-hover align-middle">
    <thead class="table-dark">
      <tr>
        <th>ID</th>
        <th>Customer</th>
        <th>Product</th>
        <th>Qty</th>
        <th>Date</th>
        <th>Total (₹)</th>
        <th>Paid (₹)</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for o in orders %}
      <tr>
        <td>{{ o.id }}</td>
        <td>{{ o.customer_display or o.customer_phone or 'N/A' }}</td>
        <td>{{ o.product_name }}</td>
        <td>{{ o.quantity }}</td>
        <td>{{ o.date }}</td>

        <td>
          {% if o.total_cost %}
            <span class="badge bg-success">₹{{ '%.2f'|format(o.total_cost) }}</span>
          {% else %}
            <span class="text-muted">Not set</span>
          {% endif %}
          <button class="btn btn-sm btn-outline-primary ms-2" data-bs-toggle="collapse" data-bs-target="#editTotal{{ o.id }}">Edit</button>
          <div class="collapse mt-2" id="editTotal{{ o.id }}">
            <form method="post" class="d-flex gap-2">
              <input type="hidden" name="order_id" value="{{ o.id }}">
              <input type="hidden" name="action" value="update_total_cost">
              <input type="number" step="0.01" name="total_cost" value="{{ o.total_cost or '' }}" class="form-control form-control-sm" placeholder="Enter new total">
              <button class="btn btn-sm btn-outline-success">Save</button>
            </form>
          </div>
        </td>

        <td>
          {% if o.amount_paid %}
            <span class="badge bg-info">₹{{ '%.2f'|format(o.amount_paid) }}</span>
          {% else %}
            <span class="text-muted">0.00</span>
          {% endif %}
          <button class="btn btn-sm btn-outline-success ms-2" data-bs-toggle="collapse" data-bs-target="#addPaid{{ o.id }}">Add</button>
          <div class="collapse mt-2" id="addPaid{{ o.id }}">
            <form method="post" class="d-flex gap-2">
              <input type="hidden" name="order_id" value="{{ o.id }}">
              <input type="hidden" name="action" value="update_paid">
              <input type="number" step="0.01" name="amount_paid" class="form-control form-control-sm" placeholder="Add amount">
              <button class="btn btn-sm btn-outline-success">Save</button>
            </form>
          </div>
        </td>

        <td>
          <form method="post" class="d-flex gap-2 align-items-center">
            <input type="hidden" name="order_id" value="{{ o.id }}">
            <input type="hidden" name="action" value="update_status">
            <select name="status" class="form-select form-select-sm w-auto">
              {% for s in ['Pending','In Progress','Completed'] %}
                <option value="{{ s }}" {% if o.status==s %}selected{% endif %}>{{ s }}</option>
              {% endfor %}
            </select>
            <button class="btn btn-sm btn-outline-primary">Save</button>
          </form>
        </td>

        <td>
          <div class="d-flex flex-wrap gap-1">
            <a href="{{ url_for('owner_edit_order', order_id=o.id) }}" class="btn btn-sm btn-outline-secondary">Edit</a>
            <form method="post" onsubmit="return confirm('Delete this order?')" style="display:inline;">
              <input type="hidden" name="order_id" value="{{ o.id }}">
              <input type="hidden" name="action" value="delete_order">
              <button class="btn btn-sm btn-outline-danger">Delete</button>
            </form>
            <a href="{{ url_for('download_bill_pdf', order_ids=o.id) }}" class="btn btn-sm btn-outline-info">Bill</a>
            <button class="btn btn-sm btn-outline-dark" data-bs-toggle="collapse" data-bs-target="#items{{ o.id }}">Items Used</button>
          </div>
        </td>
      </tr>

      <!-- ✅ Collapsible section for used items -->
      <tr class="collapse" id="items{{ o.id }}">
        <td colspan="9">
          <div class="p-3 bg-light rounded border">
            <h6>Items Used for Order #{{ o.id }}</h6>

            {% set used_items = used.get(o.id, []) %}
            {% if used_items %}
              <ul class="list-group mb-2">
                {% for item in used_items %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  {{ item.item_name }} ({{ item.size or '-' }})
                  <span class="badge bg-primary">{{ item.quantity_used }}</span>
                </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-muted small">No items used yet.</p>
            {% endif %}

            <!-- Add New Item Inline -->
            <form method="post" action="{{ url_for('add_order_item', order_id=o.id) }}" class="row g-2 mt-2">
              <div class="col-md-5">
                <select name="stock_id" class="form-select form-select-sm" required>
                  <option value="" disabled selected>Select stock item...</option>
                  {% for s in stock %}
                    <option value="{{ s.id }}">{{ s.item_name }} ({{ s.size or '' }}) — {{ s.quantity }} in stock</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-3">
                <input type="number" step="0.01" min="0.01" name="qty_used" class="form-control form-control-sm" placeholder="Qty" required>
              </div>
              <div class="col-md-2">
                <button class="btn btn-sm btn-outline-secondary w-100">Add</button>
              </div>
            </form>
          </div>
        </td>
      </tr>

      {% endfor %}
    </tbody>
  </table>
</div>

{% endblock %}
